# 實作案例 2：自動寄送通知信系統

## 專案概述

本專案將建立一個自動寄送通知信的系統，能夠從試算表讀取待通知名單，根據不同條件發送客製化郵件，並記錄寄送狀態。系統將使用時間觸發器實現每日自動檢查與寄送功能。

## 學習目標

完成本專案後，你將能夠：

✅ 整合 SpreadsheetApp 與 MailApp 服務
✅ 建立並管理時間觸發器
✅ 實作錯誤處理與重試機制
✅ 記錄系統執行狀態
✅ 產生客製化郵件內容

## 專案需求

### 功能需求

1. **讀取待通知名單**
   - 從試算表讀取待通知的收件者資料
   - 支援多種通知類型
   - 過濾已發送的記錄

2. **客製化郵件內容**
   - 根據通知類型產生不同的郵件內容
   - 支援個人化資訊（姓名、日期等）
   - 支援 HTML 格式郵件

3. **郵件發送**
   - 批次發送郵件
   - 檢查郵件配額
   - 避免重複發送

4. **寄送狀態記錄**
   - 記錄發送時間
   - 記錄發送狀態（成功/失敗）
   - 記錄錯誤訊息

5. **錯誤處理與重試**
   - 捕捉發送錯誤
   - 自動重試失敗的郵件
   - 通知管理員系統錯誤

6. **自動化執行**
   - 設定時間觸發器
   - 每日自動檢查與發送
   - 可手動觸發執行

### 非功能需求

- 執行效率：批次處理，避免超時
- 可靠性：完整的錯誤處理機制
- 可維護性：清晰的程式碼結構與註解
- 可擴展性：易於新增通知類型

## 試算表資料結構

### 工作表 1：通知名單

| 欄位 | 說明 | 範例 |
|------|------|------|
| 姓名 | 收件者姓名 | 王小明 |
| Email | 收件者信箱 | student@example.com |
| 通知類型 | 通知類別 | 課程提醒 / 作業提醒 / 活動通知 |
| 狀態 | 發送狀態 | 待發送 / 已發送 / 發送失敗 |
| 寄送時間 | 實際發送時間 | 2024-12-15 08:30:00 |
| 備註 | 額外資訊 | 期中考提醒 |
| 重試次數 | 失敗重試次數 | 0 |

### 工作表 2：發送記錄

| 欄位 | 說明 |
|------|------|
| 執行時間 | 系統執行時間 |
| 發送數量 | 本次發送郵件數 |
| 成功數量 | 發送成功數 |
| 失敗數量 | 發送失敗數 |
| 執行狀態 | 整體執行狀態 |
| 錯誤訊息 | 錯誤詳情 |

## 通知類型定義

### 1. 課程提醒

**觸發條件：** 課程開始前一天
**郵件內容：**
- 課程名稱
- 上課時間
- 上課地點
- 注意事項

### 2. 作業提醒

**觸發條件：** 作業截止前三天
**郵件內容：**
- 作業名稱
- 截止日期
- 繳交方式
- 評分標準

### 3. 活動通知

**觸發條件：** 活動開始前一週
**郵件內容：**
- 活動名稱
- 活動時間
- 活動地點
- 報名連結

### 4. 成績通知

**觸發條件：** 成績公布時
**郵件內容：**
- 科目名稱
- 成績資訊
- 查詢方式

## 系統流程圖

```
開始
  ↓
檢查郵件配額
  ↓
讀取待發送名單
  ↓
過濾已發送記錄
  ↓
逐一處理每筆記錄
  ↓
產生客製化郵件內容
  ↓
發送郵件
  ↓
更新發送狀態
  ↓
記錄執行結果
  ↓
結束
```

## 錯誤處理策略

### 1. 配額不足

- 檢查剩餘配額
- 配額不足時停止執行
- 發送警告郵件給管理員

### 2. 發送失敗

- 記錄失敗原因
- 更新重試次數
- 超過重試上限後標記為失敗

### 3. 資料格式錯誤

- 驗證 Email 格式
- 驗證必填欄位
- 記錄錯誤資訊

### 4. 系統錯誤

- 捕捉所有例外
- 記錄錯誤堆疊
- 通知管理員

## 開發步驟

### 階段 1：基礎設定（30 分鐘）

1. 建立試算表與工作表
2. 設定欄位標題
3. 準備測試資料

### 階段 2：讀取資料功能（30 分鐘）

1. 實作讀取通知名單函式
2. 實作過濾待發送記錄函式
3. 測試資料讀取

### 階段 3：郵件內容產生（45 分鐘）

1. 實作各類型郵件範本
2. 實作個人化內容產生函式
3. 測試郵件內容

### 階段 4：郵件發送功能（30 分鐘）

1. 實作郵件發送函式
2. 實作配額檢查
3. 測試郵件發送

### 階段 5：狀態記錄功能（30 分鐘）

1. 實作更新發送狀態函式
2. 實作執行記錄函式
3. 測試記錄功能

### 階段 6：錯誤處理（30 分鐘）

1. 加入錯誤捕捉
2. 實作重試機制
3. 實作管理員通知

### 階段 7：觸發器設定（15 分鐘）

1. 建立時間觸發器
2. 測試自動執行
3. 調整執行時間

## 測試計畫

### 單元測試

- [ ] 測試讀取通知名單
- [ ] 測試過濾待發送記錄
- [ ] 測試郵件內容產生
- [ ] 測試郵件發送
- [ ] 測試狀態更新
- [ ] 測試錯誤處理

### 整合測試

- [ ] 測試完整流程（手動執行）
- [ ] 測試觸發器自動執行
- [ ] 測試配額不足情況
- [ ] 測試發送失敗重試
- [ ] 測試大量資料處理

### 驗收測試

- [ ] 確認所有通知類型正常運作
- [ ] 確認狀態記錄正確
- [ ] 確認錯誤處理完整
- [ ] 確認觸發器穩定執行

## 擴展功能建議

完成基本功能後，可以考慮加入以下擴展功能：

1. **優先級管理**
   - 設定郵件優先級
   - 高優先級郵件優先發送

2. **排程管理**
   - 設定特定發送時間
   - 支援延遲發送

3. **範本管理**
   - 建立郵件範本庫
   - 支援自訂範本

4. **統計報表**
   - 產生發送統計圖表
   - 分析發送成功率

5. **收件者管理**
   - 支援群組管理
   - 支援黑名單功能

## 常見問題

### Q1: 如何避免重複發送？

在發送前檢查狀態欄位，只處理「待發送」狀態的記錄。

### Q2: 如何處理大量收件者？

使用批次處理，每次處理固定數量，避免超時。

### Q3: 觸發器沒有執行怎麼辦？

檢查觸發器設定、查看執行記錄、確認權限設定。

### Q4: 如何測試不實際發送郵件？

建立測試模式，將郵件內容記錄到試算表而不實際發送。

### Q5: 如何處理 Email 格式錯誤？

在發送前驗證 Email 格式，格式錯誤的記錄標記為失敗。

## 學習資源

- [MailApp 官方文件](https://developers.google.com/apps-script/reference/mail/mail-app)
- [SpreadsheetApp 官方文件](https://developers.google.com/apps-script/reference/spreadsheet/spreadsheet-app)
- [Triggers 官方文件](https://developers.google.com/apps-script/guides/triggers)

## 專案檢查清單

完成專案前，請確認以下項目：

- [ ] 試算表結構正確
- [ ] 所有函式都有註解
- [ ] 錯誤處理完整
- [ ] 測試資料準備完成
- [ ] 所有測試通過
- [ ] 觸發器設定正確
- [ ] 程式碼已優化
- [ ] 文件已完成

## 總結

本專案整合了 SpreadsheetApp、MailApp 和 Triggers 三個核心服務，是一個完整的自動化應用案例。透過本專案，你將學會如何建立一個穩定、可靠的自動化通知系統。

完成本專案後，你可以將相同的概念應用到其他場景，如：
- 自動發送生日祝福
- 定期發送報表
- 自動提醒待辦事項
- 批次發送通知信

祝你開發順利！
