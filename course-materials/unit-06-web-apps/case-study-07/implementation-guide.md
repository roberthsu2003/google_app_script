# 實作案例 7：每日報表寄送機器人 - 實作指引

## 專案目標

建立一個自動化報表系統，能夠從試算表提取資料、產生美化的 HTML 報表，並定時寄送給指定收件者。

## 學習重點

- Web App 介面設計與實作
- 試算表資料讀取與處理
- HTML 報表格式化
- 郵件自動寄送
- 時間觸發器設定與管理

## 實作步驟

### 階段 1：環境準備（15 分鐘）

#### 1.1 建立 Google 試算表

1. 開啟 Google 試算表
2. 建立新試算表，命名為「報表寄送系統」
3. 記下試算表 ID（網址中的長字串）

#### 1.2 建立 Apps Script 專案

1. 在試算表中，點選「擴充功能」→「Apps Script」
2. 刪除預設的 `myFunction()`
3. 將專案命名為「報表寄送機器人」

#### 1.3 準備檔案

建立以下檔案：
- `Code.gs`：主要程式碼
- `Index.html`：Web 介面

### 階段 2：基礎設定（20 分鐘）

#### 2.1 設定試算表 ID

在 `Code.gs` 中修改：

```javascript
var SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID'; // 替換為您的試算表 ID
```

#### 2.2 執行初始化

1. 在 Apps Script 編輯器中，選擇 `setup` 函式
2. 點選「執行」
3. 授權應用程式存取權限
4. 檢查試算表是否建立了以下工作表：
   - 報表設定
   - 銷售資料

#### 2.3 檢查範例資料

查看「銷售資料」工作表，應該包含：
- 日期、產品、數量、單價、金額欄位
- 10 筆範例資料

### 階段 3：Web 介面測試（20 分鐘）

#### 3.1 部署 Web App

1. 點選「部署」→「新增部署作業」
2. 選擇類型：「網頁應用程式」
3. 設定：
   - 說明：報表寄送機器人 v1
   - 執行身分：我
   - 具有存取權的使用者：僅限本人
4. 點選「部署」
5. 複製 Web App 網址

#### 3.2 測試介面

1. 開啟 Web App 網址
2. 檢查介面是否正常顯示
3. 確認設定欄位：
   - 收件者 Email
   - 報表類型
   - 寄送時間
   - 啟用狀態

#### 3.3 修改設定

1. 輸入您的 Email
2. 選擇報表類型
3. 設定寄送時間
4. 點選「儲存設定」
5. 檢查「報表設定」工作表是否更新

### 階段 4：報表產生功能（25 分鐘）

#### 4.1 理解資料提取邏輯

`getTodayData()` 函式：
- 讀取「銷售資料」工作表
- 篩選今日的資料
- 回傳符合條件的記錄

#### 4.2 理解統計計算

`calculateStatistics()` 函式計算：
- 總銷售數量
- 總銷售金額
- 銷售產品數

#### 4.3 測試報表產生

1. 在 Apps Script 編輯器中執行 `testReport()`
2. 查看執行記錄（Ctrl/Cmd + Enter）
3. 檢查產生的 HTML 內容

#### 4.4 自訂報表樣式

修改 `generateReport()` 中的 CSS：

```javascript
html += 'th { background-color: #3498db; color: white; }'; // 修改表頭顏色
html += 'tr:nth-child(even) { background-color: #f2f2f2; }'; // 修改偶數列顏色
```

### 階段 5：郵件寄送功能（20 分鐘）

#### 5.1 測試手動寄送

1. 開啟 Web App
2. 確認收件者 Email 正確
3. 點選「立即寄送」
4. 檢查 Email 信箱

#### 5.2 檢查郵件內容

確認郵件包含：
- 正確的主旨（日期）
- 統計摘要
- 詳細資料表格
- 美化的 HTML 格式

#### 5.3 查看寄送記錄

檢查「寄送記錄」工作表：
- 寄送時間
- 收件者
- 狀態

### 階段 6：定時觸發器設定（20 分鐘）

#### 6.1 設定觸發器

1. 開啟 Web App
2. 設定寄送時間（例如：09:00）
3. 確認「啟用自動寄送」已勾選
4. 點選「設定排程」

#### 6.2 檢查觸發器

1. 在 Apps Script 編輯器中
2. 點選左側「觸發器」圖示（時鐘）
3. 確認已建立 `sendReport` 觸發器
4. 檢查執行時間設定

#### 6.3 測試觸發器管理

1. 修改寄送時間
2. 再次點選「設定排程」
3. 確認舊觸發器已刪除，新觸發器已建立

### 階段 7：錯誤處理與優化（20 分鐘）

#### 7.1 測試錯誤情境

測試以下情況：
1. 未設定收件者
2. 停用自動寄送
3. 無今日資料

#### 7.2 查看錯誤訊息

檢查：
- Web 介面的錯誤提示
- Apps Script 執行記錄
- 郵件寄送狀態

#### 7.3 新增資料驗證

在 `sendReport()` 中新增檢查：

```javascript
// 驗證 Email 格式
if (!config.recipient.includes('@')) {
  throw new Error('Email 格式不正確');
}
```

## 功能測試清單

### 基本功能

- [ ] 系統初始化成功
- [ ] Web 介面正常顯示
- [ ] 設定儲存功能正常
- [ ] 設定載入功能正常

### 報表功能

- [ ] 資料提取正確
- [ ] 統計計算正確
- [ ] HTML 報表格式正確
- [ ] 無資料時顯示適當訊息

### 郵件功能

- [ ] 手動寄送成功
- [ ] 郵件內容正確
- [ ] 郵件格式美觀
- [ ] 寄送記錄正確

### 觸發器功能

- [ ] 觸發器建立成功
- [ ] 觸發器時間正確
- [ ] 舊觸發器正確刪除
- [ ] 停用時不建立觸發器

### 錯誤處理

- [ ] 未設定收件者時顯示錯誤
- [ ] 停用時不寄送
- [ ] 錯誤訊息清楚明確

## 常見問題

### Q1：收不到郵件

**可能原因：**
- Email 地址錯誤
- 郵件被歸類為垃圾郵件
- 超過每日寄送配額

**解決方法：**
1. 檢查 Email 拼寫
2. 查看垃圾郵件資料夾
3. 查看 Apps Script 執行記錄

### Q2：觸發器沒有執行

**可能原因：**
- 觸發器設定錯誤
- 功能已停用
- 權限問題

**解決方法：**
1. 檢查觸發器列表
2. 確認啟用狀態
3. 重新授權應用程式

### Q3：報表沒有資料

**可能原因：**
- 今日沒有資料
- 日期格式不符
- 工作表名稱錯誤

**解決方法：**
1. 檢查「銷售資料」工作表
2. 確認日期格式為 yyyy-MM-dd
3. 手動新增今日資料測試

### Q4：Web App 無法開啟

**可能原因：**
- 部署設定錯誤
- 權限不足
- 檔案名稱錯誤

**解決方法：**
1. 重新部署 Web App
2. 檢查存取權限設定
3. 確認 HTML 檔案名稱為 `Index.html`

## 延伸練習

### 初級

1. **新增報表類型**
   - 實作每週報表
   - 實作每月報表
   - 根據報表類型調整資料範圍

2. **美化郵件樣式**
   - 修改顏色配置
   - 新增公司 Logo
   - 調整字型大小

3. **新增收件者**
   - 支援多個收件者
   - 新增副本（CC）功能
   - 新增密件副本（BCC）功能

### 中級

4. **圖表功能**
   - 使用 Google Charts API
   - 產生銷售趨勢圖
   - 產生產品分布圖

5. **報表範本**
   - 建立多種報表範本
   - 支援範本選擇
   - 自訂範本欄位

6. **資料篩選**
   - 新增日期範圍選擇
   - 新增產品篩選
   - 新增金額範圍篩選

### 進階

7. **報表歷史**
   - 儲存歷史報表
   - 提供報表查詢功能
   - 支援報表下載

8. **效能優化**
   - 實作資料快取
   - 批次處理大量資料
   - 非同步處理

9. **進階通知**
   - 異常值警示
   - 目標達成通知
   - 自訂通知規則

## 學習資源

### 官方文件

- [SpreadsheetApp 文件](https://developers.google.com/apps-script/reference/spreadsheet)
- [MailApp 文件](https://developers.google.com/apps-script/reference/mail)
- [HTML Service 文件](https://developers.google.com/apps-script/guides/html)
- [Triggers 文件](https://developers.google.com/apps-script/guides/triggers)

### 相關主題

- HTML/CSS 基礎
- JavaScript 日期處理
- 郵件格式設計
- 資料視覺化

## 專案檢核表

完成以下項目即完成本實作案例：

- [ ] 成功建立並初始化系統
- [ ] Web 介面功能完整
- [ ] 報表產生功能正常
- [ ] 郵件寄送功能正常
- [ ] 定時觸發器設定成功
- [ ] 錯誤處理完善
- [ ] 完成至少 2 個延伸練習
- [ ] 程式碼有適當註解
- [ ] 測試所有功能
- [ ] 撰寫使用說明文件

## 評估標準

| 項目 | 優秀 (90-100) | 良好 (80-89) | 及格 (70-79) | 待改進 (<70) |
|------|--------------|-------------|-------------|-------------|
| 功能完整性 | 所有功能正常運作 | 主要功能正常 | 基本功能正常 | 功能不完整 |
| 介面設計 | 美觀且易用 | 清楚明瞭 | 基本可用 | 不易使用 |
| 程式品質 | 結構清晰、註解完整 | 結構良好 | 基本可讀 | 難以理解 |
| 錯誤處理 | 完善的錯誤處理 | 基本錯誤處理 | 部分錯誤處理 | 缺乏錯誤處理 |
| 延伸功能 | 完成 3+ 個延伸 | 完成 2 個延伸 | 完成 1 個延伸 | 無延伸功能 |

## 總結

本實作案例整合了：
- Web App 開發
- 試算表操作
- 郵件自動化
- 觸發器管理

完成後，您將能夠：
- 建立實用的自動化報表系統
- 設計友善的 Web 介面
- 處理定時任務
- 整合多個 Google 服務

這些技能可應用於各種自動化場景，如：
- 業務報表系統
- 監控警示系統
- 定期通知系統
- 資料同步系統
