<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>æª”æ¡ˆä¸Šå‚³ç®¡ç†å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, "Microsoft JhengHei", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .header {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .header h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #7f8c8d;
    }
    
    .stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      flex: 1;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    .stat-card .number {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .stat-card .label {
      color: #7f8c8d;
      font-size: 14px;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
    }
    
    .upload-section {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .upload-section h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    
    .upload-area:hover {
      background-color: #f8f9fa;
      border-color: #764ba2;
    }
    
    .upload-area.dragover {
      background-color: #e8f4f8;
      border-color: #3498db;
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .upload-text {
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .file-input {
      display: none;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .file-list-section {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .file-list-section h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .search-box {
      margin-bottom: 20px;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .file-list {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }
    
    .file-item:hover {
      background-color: #f8f9fa;
      border-color: #667eea;
    }
    
    .file-icon {
      font-size: 32px;
      margin-right: 15px;
    }
    
    .file-info {
      flex: 1;
    }
    
    .file-name {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    
    .file-meta {
      font-size: 12px;
      color: #7f8c8d;
    }
    
    .file-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-view {
      background-color: #3498db;
      color: white;
    }
    
    .btn-view:hover {
      background-color: #2980b9;
    }
    
    .message {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }
    
    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .message.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background-color: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin-top: 15px;
      display: none;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .stats {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ¨™é¡Œå€ -->
    <div class="header">
      <h1>ğŸ“ æª”æ¡ˆä¸Šå‚³ç®¡ç†å·¥å…·</h1>
      <p>è¼•é¬†ä¸Šå‚³ã€ç®¡ç†å’Œåˆ†äº«æ‚¨çš„æª”æ¡ˆ</p>
    </div>
    
    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="stats">
      <div class="stat-card">
        <div class="number" id="totalFiles">0</div>
        <div class="label">ç¸½æª”æ¡ˆæ•¸</div>
      </div>
      <div class="stat-card">
        <div class="number" id="totalSize">0 MB</div>
        <div class="label">ç¸½å¤§å°</div>
      </div>
      <div class="stat-card">
        <div class="number" id="totalUploaders">0</div>
        <div class="label">ä¸Šå‚³è€…</div>
      </div>
    </div>
    
    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-content">
      <!-- ä¸Šå‚³å€ -->
      <div class="upload-section">
        <h2>ğŸ“¤ ä¸Šå‚³æª”æ¡ˆ</h2>
        
        <div class="message" id="uploadMessage"></div>
        
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">â˜ï¸</div>
          <div class="upload-text">
            <strong>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•</strong><br>
            <span id="uploadHint">æ”¯æ´å¤šç¨®æª”æ¡ˆæ ¼å¼</span>
          </div>
          <input type="file" id="fileInput" class="file-input">
        </div>
        
        <button class="btn btn-primary" id="uploadBtn" style="width: 100%;" disabled>
          é¸æ“‡æª”æ¡ˆ
        </button>
        
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill">0%</div>
        </div>
      </div>
      
      <!-- æª”æ¡ˆæ¸…å–®å€ -->
      <div class="file-list-section">
        <h2>ğŸ“‹ æª”æ¡ˆæ¸…å–®</h2>
        
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹æª”æ¡ˆåç¨±æˆ–ä¸Šå‚³è€…...">
        </div>
        
        <div class="file-list" id="fileList">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‚</div>
            <p>å°šç„¡æª”æ¡ˆ</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var selectedFile = null;
    var uploadConfig = null;
    
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.onload = function() {
      loadConfig();
      loadStatistics();
      loadFileList();
      setupEventListeners();
    };
    
    /**
     * è¼‰å…¥ä¸Šå‚³è¨­å®š
     */
    function loadConfig() {
      google.script.run
        .withSuccessHandler(function(config) {
          uploadConfig = config;
          updateUploadHint();
        })
        .withFailureHandler(function(error) {
          showMessage('è¼‰å…¥è¨­å®šå¤±æ•—ï¼š' + error.message, 'error', 'uploadMessage');
        })
        .getUploadConfig();
    }
    
    /**
     * æ›´æ–°ä¸Šå‚³æç¤º
     */
    function updateUploadHint() {
      if (!uploadConfig) return;
      
      var hint = 'æª”æ¡ˆå¤§å°é™åˆ¶ï¼š' + uploadConfig.maxFileSizeMB + ' MB';
      if (!uploadConfig.allowAllTypes) {
        hint += ' | æ”¯æ´ï¼šPDF, åœ–ç‰‡, Word, Excel';
      }
      document.getElementById('uploadHint').textContent = hint;
    }
    
    /**
     * è¨­å®šäº‹ä»¶ç›£è½å™¨
     */
    function setupEventListeners() {
      var uploadArea = document.getElementById('uploadArea');
      var fileInput = document.getElementById('fileInput');
      var uploadBtn = document.getElementById('uploadBtn');
      var searchInput = document.getElementById('searchInput');
      
      // é»æ“Šä¸Šå‚³å€åŸŸ
      uploadArea.addEventListener('click', function() {
        fileInput.click();
      });
      
      // é¸æ“‡æª”æ¡ˆ
      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
      
      // æ‹–æ›³äº‹ä»¶
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
          handleFileSelect(e.dataTransfer.files[0]);
        }
      });
      
      // ä¸Šå‚³æŒ‰éˆ•
      uploadBtn.addEventListener('click', function() {
        if (selectedFile) {
          uploadFile();
        } else {
          fileInput.click();
        }
      });
      
      // æœå°‹
      searchInput.addEventListener('input', function() {
        var keyword = this.value.trim();
        if (keyword) {
          searchFiles(keyword);
        } else {
          loadFileList();
        }
      });
    }
    
    /**
     * è™•ç†æª”æ¡ˆé¸æ“‡
     */
    function handleFileSelect(file) {
      selectedFile = file;
      
      // æ›´æ–°ä¸Šå‚³å€åŸŸé¡¯ç¤º
      var uploadArea = document.getElementById('uploadArea');
      uploadArea.innerHTML = '<div class="upload-icon">ğŸ“„</div>' +
        '<div class="upload-text">' +
        '<strong>' + file.name + '</strong><br>' +
        '<span>' + formatFileSize(file.size / 1024) + '</span>' +
        '</div>';
      
      // å•Ÿç”¨ä¸Šå‚³æŒ‰éˆ•
      var uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.textContent = 'é–‹å§‹ä¸Šå‚³';
      uploadBtn.disabled = false;
    }
    
    /**
     * ä¸Šå‚³æª”æ¡ˆ
     */
    function uploadFile() {
      if (!selectedFile) return;
      
      // é©—è­‰æª”æ¡ˆå¤§å°
      var fileSizeMB = selectedFile.size / 1024 / 1024;
      if (uploadConfig && fileSizeMB > uploadConfig.maxFileSizeMB) {
        showMessage('æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ï¼ˆ' + uploadConfig.maxFileSizeMB + ' MBï¼‰', 'error', 'uploadMessage');
        return;
      }
      
      showMessage('æ­£åœ¨ä¸Šå‚³...', 'info', 'uploadMessage');
      showProgress(true);
      
      var uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.disabled = true;
      
      // è®€å–æª”æ¡ˆç‚º Base64
      var reader = new FileReader();
      
      reader.onload = function(e) {
        var base64Data = e.target.result.split(',')[1];
        
        // æ¨¡æ“¬é€²åº¦
        updateProgress(30);
        
        google.script.run
          .withSuccessHandler(function(result) {
            updateProgress(100);
            
            if (result.success) {
              showMessage('âœ… ' + result.message, 'success', 'uploadMessage');
              resetUploadArea();
              loadStatistics();
              loadFileList();
            } else {
              showMessage('âŒ ' + result.message, 'error', 'uploadMessage');
            }
            
            setTimeout(function() {
              showProgress(false);
              uploadBtn.disabled = false;
            }, 1000);
          })
          .withFailureHandler(function(error) {
            showMessage('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + error.message, 'error', 'uploadMessage');
            showProgress(false);
            uploadBtn.disabled = false;
          })
          .uploadFile(base64Data, selectedFile.name, selectedFile.type);
        
        updateProgress(60);
      };
      
      reader.onerror = function() {
        showMessage('âŒ è®€å–æª”æ¡ˆå¤±æ•—', 'error', 'uploadMessage');
        showProgress(false);
        uploadBtn.disabled = false;
      };
      
      reader.readAsDataURL(selectedFile);
    }
    
    /**
     * é‡ç½®ä¸Šå‚³å€åŸŸ
     */
    function resetUploadArea() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadArea').innerHTML =
        '<div class="upload-icon">â˜ï¸</div>' +
        '<div class="upload-text">' +
        '<strong>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•</strong><br>' +
        '<span id="uploadHint">æ”¯æ´å¤šç¨®æª”æ¡ˆæ ¼å¼</span>' +
        '</div>';
      
      updateUploadHint();
      
      var uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.textContent = 'é¸æ“‡æª”æ¡ˆ';
      uploadBtn.disabled = true;
    }
    
    /**
     * è¼‰å…¥çµ±è¨ˆè³‡è¨Š
     */
    function loadStatistics() {
      google.script.run
        .withSuccessHandler(function(stats) {
          document.getElementById('totalFiles').textContent = stats.totalFiles;
          document.getElementById('totalSize').textContent = stats.totalSizeMB + ' MB';
          document.getElementById('totalUploaders').textContent = stats.uploaders;
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—ï¼š' + error.message);
        })
        .getStatistics();
    }
    
    /**
     * è¼‰å…¥æª”æ¡ˆæ¸…å–®
     */
    function loadFileList() {
      google.script.run
        .withSuccessHandler(function(files) {
          displayFileList(files);
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥æª”æ¡ˆæ¸…å–®å¤±æ•—ï¼š' + error.message);
        })
        .getFileList(50);
    }
    
    /**
     * æœå°‹æª”æ¡ˆ
     */
    function searchFiles(keyword) {
      google.script.run
        .withSuccessHandler(function(files) {
          displayFileList(files);
        })
        .withFailureHandler(function(error) {
          console.error('æœå°‹å¤±æ•—ï¼š' + error.message);
        })
        .searchFiles(keyword);
    }
    
    /**
     * é¡¯ç¤ºæª”æ¡ˆæ¸…å–®
     */
    function displayFileList(files) {
      var fileList = document.getElementById('fileList');
      
      if (files.length === 0) {
        fileList.innerHTML = '<div class="empty-state">' +
          '<div class="empty-state-icon">ğŸ“‚</div>' +
          '<p>å°šç„¡æª”æ¡ˆ</p>' +
          '</div>';
        return;
      }
      
      var html = '';
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var icon = getFileIcon(file.mimeType);
        var timestamp = formatDate(new Date(file.timestamp));
        
        html += '<div class="file-item">' +
          '<div class="file-icon">' + icon + '</div>' +
          '<div class="file-info">' +
          '<div class="file-name">' + file.fileName + '</div>' +
          '<div class="file-meta">' +
          formatFileSize(file.fileSizeKB) + ' | ' +
          file.uploader + ' | ' +
          timestamp +
          '</div>' +
          '</div>' +
          '<div class="file-actions">' +
          '<button class="btn-small btn-view" onclick="openFile(\'' + file.shareUrl + '\')">é–‹å•Ÿ</button>' +
          '</div>' +
          '</div>';
      }
      
      fileList.innerHTML = html;
    }
    
    /**
     * é–‹å•Ÿæª”æ¡ˆ
     */
    function openFile(url) {
      window.open(url, '_blank');
    }
    
    /**
     * å–å¾—æª”æ¡ˆåœ–ç¤º
     */
    function getFileIcon(mimeType) {
      var icons = {
        'application/pdf': 'ğŸ“„',
        'image/jpeg': 'ğŸ–¼ï¸',
        'image/png': 'ğŸ–¼ï¸',
        'image/gif': 'ğŸ–¼ï¸',
        'application/msword': 'ğŸ“',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'ğŸ“',
        'application/vnd.ms-excel': 'ğŸ“Š',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'ğŸ“Š',
        'application/zip': 'ğŸ“¦',
        'text/plain': 'ğŸ“ƒ'
      };
      
      return icons[mimeType] || 'ğŸ“';
    }
    
    /**
     * æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
     */
    function formatFileSize(sizeKB) {
      if (sizeKB < 1024) {
        return sizeKB.toFixed(2) + ' KB';
      } else {
        return (sizeKB / 1024).toFixed(2) + ' MB';
      }
    }
    
    /**
     * æ ¼å¼åŒ–æ—¥æœŸ
     */
    function formatDate(date) {
      var year = date.getFullYear();
      var month = ('0' + (date.getMonth() + 1)).slice(-2);
      var day = ('0' + date.getDate()).slice(-2);
      var hours = ('0' + date.getHours()).slice(-2);
      var minutes = ('0' + date.getMinutes()).slice(-2);
      
      return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
    }
    
    /**
     * é¡¯ç¤ºè¨Šæ¯
     */
    function showMessage(text, type, elementId) {
      var messageDiv = document.getElementById(elementId);
      messageDiv.textContent = text;
      messageDiv.className = 'message ' + type;
      messageDiv.style.display = 'block';
      
      setTimeout(function() {
        messageDiv.style.display = 'none';
      }, 5000);
    }
    
    /**
     * é¡¯ç¤º/éš±è—é€²åº¦æ¢
     */
    function showProgress(show) {
      var progressBar = document.getElementById('progressBar');
      progressBar.style.display = show ? 'block' : 'none';
      if (!show) {
        updateProgress(0);
      }
    }
    
    /**
     * æ›´æ–°é€²åº¦
     */
    function updateProgress(percent) {
      var progressFill = document.getElementById('progressFill');
      progressFill.style.width = percent + '%';
      progressFill.textContent = percent + '%';
    }
  </script>
</body>
</html>
