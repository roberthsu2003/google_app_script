# 實作案例 8：專案檔案上傳管理工具 - 實作指引

## 專案目標

建立一個完整的檔案上傳管理系統，讓使用者透過美觀的 Web 介面上傳檔案到 Google Drive，並自動記錄管理所有上傳資訊。

## 學習重點

- 檔案上傳處理（Base64 編碼）
- DriveApp 檔案操作
- 拖曳上傳功能
- 檔案清單管理
- 搜尋與篩選功能
- 響應式介面設計

## 實作步驟

### 階段 1：環境準備（15 分鐘）

#### 1.1 建立 Google 試算表

1. 開啟 Google 試算表
2. 建立新試算表，命名為「檔案上傳管理系統」
3. 記下試算表 ID

#### 1.2 建立 Google Drive 資料夾

1. 開啟 Google Drive
2. 建立新資料夾，命名為「專案檔案上傳」
3. 開啟資料夾，從網址列複製資料夾 ID
   - 網址格式：`https://drive.google.com/drive/folders/FOLDER_ID`
   - 複製 `FOLDER_ID` 部分

#### 1.3 建立 Apps Script 專案

1. 在試算表中，點選「擴充功能」→「Apps Script」
2. 建立以下檔案：
   - `Code.gs`：主要程式碼
   - `Index.html`：Web 介面

#### 1.4 設定 ID

在 `Code.gs` 中修改：

```javascript
var SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID'; // 試算表 ID
var UPLOAD_FOLDER_ID = 'YOUR_FOLDER_ID';    // 資料夾 ID
```

### 階段 2：系統初始化（15 分鐘）

#### 2.1 執行初始化

1. 在 Apps Script 編輯器中，選擇 `setup` 函式
2. 點選「執行」
3. 授權應用程式存取權限
4. 檢查試算表是否建立「上傳記錄」工作表

#### 2.2 檢查工作表結構

「上傳記錄」工作表應包含以下欄位：
- 上傳時間
- 檔案名稱
- 檔案類型
- 檔案大小(KB)
- 上傳者
- 檔案 ID
- 分享連結

#### 2.3 測試系統

執行 `testSystem()` 函式，檢查：
- 檔案清單功能
- 統計資訊功能

### 階段 3：Web 介面部署（20 分鐘）

#### 3.1 部署 Web App

1. 點選「部署」→「新增部署作業」
2. 選擇類型：「網頁應用程式」
3. 設定：
   - 說明：檔案上傳管理工具 v1
   - 執行身分：我
   - 具有存取權的使用者：僅限本人
4. 點選「部署」
5. 複製 Web App 網址

#### 3.2 測試介面

1. 開啟 Web App 網址
2. 檢查介面元素：
   - 統計卡片（總檔案數、總大小、上傳者）
   - 上傳區域
   - 檔案清單
   - 搜尋框

#### 3.3 檢查響應式設計

在不同裝置上測試：
- 桌面瀏覽器
- 平板（可用瀏覽器開發者工具模擬）
- 手機（可用瀏覽器開發者工具模擬）

### 階段 4：檔案上傳功能（30 分鐘）

#### 4.1 測試點擊上傳

1. 點擊上傳區域
2. 選擇一個小檔案（< 1 MB）
3. 點選「開始上傳」
4. 觀察：
   - 進度條顯示
   - 成功訊息
   - 統計資訊更新
   - 檔案清單更新

#### 4.2 測試拖曳上傳

1. 從電腦檔案總管拖曳檔案到上傳區域
2. 觀察拖曳效果（邊框顏色變化）
3. 放開檔案
4. 檢查上傳結果

#### 4.3 理解上傳流程

上傳流程：
1. 使用者選擇檔案
2. JavaScript 讀取檔案為 Base64
3. 傳送到 Apps Script
4. Apps Script 解碼並建立 Drive 檔案
5. 記錄到試算表
6. 回傳結果給前端

#### 4.4 測試檔案類型限制

修改 `ALLOWED_FILE_TYPES` 設定：

```javascript
var ALLOWED_FILE_TYPES = ['application/pdf']; // 只允許 PDF
```

重新部署後測試上傳其他類型檔案。

#### 4.5 測試檔案大小限制

修改 `MAX_FILE_SIZE_MB` 設定：

```javascript
var MAX_FILE_SIZE_MB = 1; // 限制 1 MB
```

測試上傳超過限制的檔案。

### 階段 5：檔案清單功能（25 分鐘）

#### 5.1 檢查檔案顯示

確認檔案清單顯示：
- 檔案圖示（根據類型）
- 檔案名稱
- 檔案大小
- 上傳者
- 上傳時間
- 開啟按鈕

#### 5.2 測試檔案開啟

1. 點選任一檔案的「開啟」按鈕
2. 確認在新分頁開啟 Google Drive 檔案
3. 檢查檔案內容正確

#### 5.3 測試搜尋功能

1. 在搜尋框輸入檔案名稱關鍵字
2. 確認清單即時篩選
3. 測試搜尋上傳者名稱
4. 清空搜尋框，確認顯示所有檔案

#### 5.4 理解清單邏輯

`getFileList()` 函式：
- 從試算表讀取記錄
- 限制回傳筆數（預設 50）
- 最新的檔案在前

`searchFiles()` 函式：
- 搜尋檔案名稱和上傳者
- 不區分大小寫
- 回傳符合的記錄

### 階段 6：統計功能（15 分鐘）

#### 6.1 理解統計計算

`getStatistics()` 函式計算：
- 總檔案數
- 總檔案大小（KB 和 MB）
- 上傳者數量

#### 6.2 測試統計更新

1. 上傳新檔案
2. 觀察統計卡片即時更新
3. 檢查數字正確性

#### 6.3 驗證試算表資料

1. 開啟試算表
2. 查看「上傳記錄」工作表
3. 確認：
   - 每次上傳都有記錄
   - 時間格式正確
   - 連結可點擊

### 階段 7：進階功能（30 分鐘）

#### 7.1 新增檔案刪除功能

在 `Index.html` 的檔案項目中新增刪除按鈕：

```javascript
'<button class="btn-small btn-delete" onclick="deleteFile(\'' + file.fileId + '\')">刪除</button>'
```

新增刪除函式：

```javascript
function deleteFile(fileId) {
  if (!confirm('確定要刪除此檔案嗎？')) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showMessage('✅ ' + result.message, 'success', 'uploadMessage');
        loadStatistics();
        loadFileList();
      } else {
        showMessage('❌ ' + result.message, 'error', 'uploadMessage');
      }
    })
    .withFailureHandler(function(error) {
      showMessage('❌ 刪除失敗：' + error.message, 'error', 'uploadMessage');
    })
    .deleteFile(fileId);
}
```

#### 7.2 新增檔案類型篩選

在搜尋框下方新增類型篩選器：

```html
<select id="typeFilter" onchange="filterByType()">
  <option value="">所有類型</option>
  <option value="application/pdf">PDF</option>
  <option value="image">圖片</option>
  <option value="document">文件</option>
</select>
```

#### 7.3 新增批次上傳

修改檔案輸入支援多選：

```html
<input type="file" id="fileInput" class="file-input" multiple>
```

修改上傳邏輯處理多個檔案。

### 階段 8：錯誤處理與優化（20 分鐘）

#### 8.1 測試錯誤情境

測試以下情況：
1. 上傳超大檔案
2. 上傳不支援的檔案類型
3. 網路中斷時上傳
4. 搜尋不存在的檔案

#### 8.2 新增錯誤訊息

確保所有錯誤都有清楚的訊息提示。

#### 8.3 效能優化

優化建議：
1. 限制檔案清單顯示數量
2. 實作分頁功能
3. 使用虛擬滾動（大量檔案時）
4. 快取統計資訊

## 功能測試清單

### 基本功能

- [ ] 系統初始化成功
- [ ] Web 介面正常顯示
- [ ] 統計資訊正確顯示

### 上傳功能

- [ ] 點擊上傳功能正常
- [ ] 拖曳上傳功能正常
- [ ] 進度條顯示正確
- [ ] 檔案類型驗證正常
- [ ] 檔案大小驗證正常
- [ ] 上傳成功訊息顯示
- [ ] 上傳失敗錯誤處理

### 檔案管理

- [ ] 檔案清單正確顯示
- [ ] 檔案圖示正確
- [ ] 檔案資訊完整
- [ ] 開啟檔案功能正常
- [ ] 搜尋功能正常
- [ ] 清單即時更新

### Drive 整合

- [ ] 檔案正確上傳到 Drive
- [ ] 檔案儲存在指定資料夾
- [ ] 分享連結正確產生
- [ ] 分享權限設定正確

### 試算表記錄

- [ ] 上傳記錄正確寫入
- [ ] 時間格式正確
- [ ] 連結可點擊
- [ ] 資料完整性

## 常見問題

### Q1：上傳大檔案失敗

**可能原因：**
- 超過大小限制
- 執行時間超時（Apps Script 限制 6 分鐘）
- 記憶體不足

**解決方法：**
1. 降低檔案大小限制
2. 使用 Google Picker API（適合大檔案）
3. 分段上傳

### Q2：檔案上傳後找不到

**可能原因：**
- 資料夾 ID 錯誤
- 權限問題
- 檔案被移動或刪除

**解決方法：**
1. 檢查 `UPLOAD_FOLDER_ID` 設定
2. 確認資料夾存取權限
3. 查看 Drive 垃圾桶

### Q3：拖曳上傳無反應

**可能原因：**
- 瀏覽器不支援
- JavaScript 錯誤
- 事件監聽器未正確設定

**解決方法：**
1. 使用現代瀏覽器（Chrome、Firefox、Edge）
2. 檢查瀏覽器控制台錯誤
3. 確認事件監聽器程式碼

### Q4：統計資訊不更新

**可能原因：**
- 試算表讀取錯誤
- 計算邏輯錯誤
- 快取問題

**解決方法：**
1. 檢查試算表 ID
2. 執行 `testSystem()` 測試
3. 重新整理頁面

## 延伸練習

### 初級

1. **檔案類型圖示**
   - 新增更多檔案類型圖示
   - 使用 Font Awesome 圖示庫
   - 自訂圖示樣式

2. **上傳歷史**
   - 顯示今日上傳數量
   - 顯示本週上傳數量
   - 建立上傳趨勢圖表

3. **使用者介面優化**
   - 新增深色模式
   - 自訂主題顏色
   - 新增動畫效果

### 中級

4. **批次操作**
   - 支援多檔案上傳
   - 批次刪除功能
   - 批次下載功能

5. **進階篩選**
   - 依檔案類型篩選
   - 依上傳日期篩選
   - 依檔案大小篩選

6. **檔案預覽**
   - 圖片預覽功能
   - PDF 預覽功能
   - 文件預覽功能

### 進階

7. **權限管理**
   - 設定檔案存取權限
   - 分享給特定使用者
   - 權限到期設定

8. **版本控制**
   - 檔案版本管理
   - 版本比較功能
   - 版本回復功能

9. **整合功能**
   - 整合 Google Picker
   - 整合 OCR 文字辨識
   - 整合病毒掃描

## 學習資源

### 官方文件

- [DriveApp 文件](https://developers.google.com/apps-script/reference/drive)
- [SpreadsheetApp 文件](https://developers.google.com/apps-script/reference/spreadsheet)
- [HTML Service 文件](https://developers.google.com/apps-script/guides/html)
- [File Upload 指南](https://developers.google.com/apps-script/guides/html/communication#forms)

### 相關技術

- Base64 編碼
- FileReader API
- Drag and Drop API
- 響應式設計

## 專案檢核表

完成以下項目即完成本實作案例：

- [ ] 成功建立並初始化系統
- [ ] Web 介面美觀且功能完整
- [ ] 檔案上傳功能正常（點擊和拖曳）
- [ ] 檔案清單顯示正確
- [ ] 搜尋功能正常
- [ ] 統計資訊準確
- [ ] Drive 整合正確
- [ ] 試算表記錄完整
- [ ] 錯誤處理完善
- [ ] 完成至少 2 個延伸練習
- [ ] 程式碼有適當註解
- [ ] 測試所有功能
- [ ] 撰寫使用說明文件

## 評估標準

| 項目 | 優秀 (90-100) | 良好 (80-89) | 及格 (70-79) | 待改進 (<70) |
|------|--------------|-------------|-------------|-------------|
| 功能完整性 | 所有功能正常運作 | 主要功能正常 | 基本功能正常 | 功能不完整 |
| 介面設計 | 美觀且易用 | 清楚明瞭 | 基本可用 | 不易使用 |
| 程式品質 | 結構清晰、註解完整 | 結構良好 | 基本可讀 | 難以理解 |
| 錯誤處理 | 完善的錯誤處理 | 基本錯誤處理 | 部分錯誤處理 | 缺乏錯誤處理 |
| 延伸功能 | 完成 3+ 個延伸 | 完成 2 個延伸 | 完成 1 個延伸 | 無延伸功能 |

## 安全性考量

### 檔案驗證

1. **檔案類型驗證**
   - 前端驗證（使用者體驗）
   - 後端驗證（安全性）
   - MIME 類型檢查

2. **檔案大小限制**
   - 防止濫用
   - 保護配額
   - 效能考量

3. **檔案名稱處理**
   - 移除特殊字元
   - 防止路徑遍歷
   - 長度限制

### 存取控制

1. **Web App 權限**
   - 適當的執行身分設定
   - 限制存取使用者
   - 定期檢查權限

2. **Drive 權限**
   - 適當的分享設定
   - 避免公開敏感檔案
   - 定期審查權限

## 總結

本實作案例整合了：
- Web App 開發
- 檔案上傳處理
- Drive 檔案管理
- 試算表記錄
- 響應式介面設計

完成後，您將能夠：
- 建立完整的檔案管理系統
- 處理檔案上傳與編碼
- 整合 Google Drive API
- 設計美觀的使用者介面
- 實作搜尋與篩選功能

這些技能可應用於：
- 文件管理系統
- 作業繳交系統
- 檔案分享平台
- 資料收集工具
